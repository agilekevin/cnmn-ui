<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>cnmn Puzzle Generator</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(165deg, #fdfbf7 0%, #f5e6d3 50%, #ecdbc8 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      color: #6b3410;
      margin-bottom: 10px;
      font-size: 32px;
      letter-spacing: 2px;
    }

    .subtitle {
      color: #8b6340;
      margin-bottom: 30px;
      font-size: 14px;
    }

    .layout {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
    }

    @media (max-width: 1024px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }

    .panel {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 4px 20px rgba(107, 52, 16, 0.1);
    }

    .panel h2 {
      color: #6b3410;
      margin-bottom: 20px;
      font-size: 20px;
      border-bottom: 2px solid #ecdbc8;
      padding-bottom: 10px;
    }

    .form-section {
      margin-bottom: 30px;
      padding: 20px;
      background: #fdfbf7;
      border-radius: 12px;
      border: 2px solid #ecdbc8;
    }

    .form-section h3 {
      color: #6b3410;
      margin-bottom: 15px;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .link-number {
      background: #6b3410;
      color: white;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      color: #6b3410;
      font-weight: 600;
      font-size: 13px;
    }

    input[type="text"],
    input[type="number"] {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #c4a574;
      border-radius: 8px;
      font-size: 14px;
      font-family: monospace;
      transition: border-color 0.2s;
    }

    input[type="text"]:focus,
    input[type="number"]:focus {
      outline: none;
      border-color: #6b3410;
    }

    .option-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .hint {
      font-size: 12px;
      color: #8b6340;
      margin-top: 5px;
      font-style: italic;
    }

    button {
      background: #6b3410;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    button:hover {
      background: #8b4513;
      transform: translateY(-2px);
    }

    button:active {
      transform: translateY(0);
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .output-area {
      background: #2d2d2d;
      color: #f8f8f2;
      padding: 20px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
      overflow-x: auto;
      white-space: pre;
      max-height: 600px;
      overflow-y: auto;
    }

    .copy-success {
      background: #4caf50;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      position: fixed;
      top: 20px;
      right: 20px;
      animation: slideIn 0.3s ease;
      z-index: 1000;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .emoji-picker {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
      margin-top: 5px;
    }

    .emoji-option {
      font-size: 24px;
      cursor: pointer;
      padding: 5px;
      border-radius: 4px;
      transition: background 0.2s;
    }

    .emoji-option:hover {
      background: rgba(107, 52, 16, 0.1);
    }

    .header-inputs {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 15px;
    }

    .image-source-toggle {
      display: flex;
      gap: 0;
      margin-bottom: 8px;
    }

    .image-source-toggle button {
      flex: 1;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 600;
      border: 2px solid #c4a574;
      background: #faf7f2;
      color: #8b6340;
      cursor: pointer;
      transition: all 0.15s;
    }

    .image-source-toggle button:first-child {
      border-radius: 6px 0 0 6px;
    }

    .image-source-toggle button:last-child {
      border-radius: 0 6px 6px 0;
    }

    .image-source-toggle button.active {
      background: #6b3410;
      color: white;
      border-color: #6b3410;
    }

    .image-source-toggle button:hover:not(.active) {
      background: #f0e4d3;
    }

    .unsplash-search-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }

    .unsplash-search-row input {
      flex: 1;
      padding: 8px 10px;
      border: 2px solid #c4a574;
      border-radius: 8px;
      font-size: 13px;
    }

    .unsplash-search-row input:focus {
      outline: none;
      border-color: #6b3410;
    }

    .unsplash-results {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-top: 8px;
    }

    .unsplash-results .thumb {
      position: relative;
      cursor: pointer;
      border-radius: 8px;
      overflow: hidden;
      aspect-ratio: 1;
      border: 2px solid transparent;
      transition: all 0.15s;
    }

    .unsplash-results .thumb:hover {
      border-color: #6b3410;
      transform: scale(1.05);
    }

    .unsplash-results .thumb.selected {
      border-color: #6b3410;
      box-shadow: 0 0 0 2px #6b3410;
    }

    .unsplash-results .thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .unsplash-results .thumb .photo-credit {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.6);
      color: white;
      font-size: 9px;
      padding: 2px 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .unsplash-status {
      font-size: 12px;
      color: #8b6340;
      font-style: italic;
      padding: 12px 0;
      text-align: center;
    }

    .selected-image-preview {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px;
      background: white;
      border: 2px solid #c4a574;
      border-radius: 8px;
      margin-top: 8px;
    }

    .selected-image-preview img {
      width: 48px;
      height: 48px;
      border-radius: 6px;
      object-fit: cover;
    }

    .selected-image-preview .info {
      flex: 1;
      font-size: 12px;
      color: #6b3410;
    }

    .selected-image-preview .info .credit {
      font-size: 11px;
      color: #8b6340;
    }

    .selected-image-preview button {
      padding: 4px 10px;
      font-size: 11px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>cnmn Puzzle Generator</h1>
    <p class="subtitle">Create new puzzle chains for your daily game</p>

    <div class="layout">
      <!-- Input Form -->
      <div class="panel">
        <h2>ğŸ“ Puzzle Details</h2>

        <div class="form-section">
          <div class="header-inputs">
            <div class="form-group">
              <label>Puzzle #</label>
              <input type="number" id="puzzleNumber" value="47" min="1">
            </div>
            <div class="form-group">
              <label>Date</label>
              <input type="text" id="puzzleDate" value="Wednesday" placeholder="e.g., Wednesday or Jan 15">
            </div>
          </div>
        </div>

        <div id="linksContainer"></div>

        <div class="button-group">
          <button onclick="generateCode()">ğŸ¯ Generate Code</button>
          <button onclick="resetForm()" style="background: #8b6340;">ğŸ”„ Reset</button>
        </div>
      </div>

      <!-- Output Panel -->
      <div class="panel">
        <h2>ğŸ“‹ Generated Code</h2>
        <div class="output-area" id="output">// Fill out the form and click "Generate Code"</div>
        <div class="button-group">
          <button onclick="copyToClipboard()">ğŸ“‹ Copy to Clipboard</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Common emojis for quick selection
    const commonEmojis = ['ğŸ¦ˆ', 'ğŸ‹', 'ğŸ ', 'ğŸŒŠ', 'âš“', 'ğŸ› ï¸', 'ğŸ”§', 'ğŸ”¨', 'âš™ï¸', 'ğŸ—¼', 'ğŸ›ï¸', 'ğŸ—¿', 'ğŸ­', 'ğŸ¨', 'ğŸª', 'â›³', 'ğŸŒï¸', 'âš½', 'ğŸ€', 'ğŸ‘”', 'ğŸ‘•', 'ğŸ‘—', 'ğŸ©', 'ğŸ•', 'ğŸ”', 'ğŸ°', 'ğŸ‚', 'ğŸš—', 'ğŸš•', 'âœˆï¸', 'ğŸš€', 'ğŸŒ™', 'â­', 'â˜€ï¸', 'ğŸŒˆ', 'ğŸ”¥', 'ğŸ’', 'ğŸ‘‘', 'ğŸ¸', 'ğŸ¹', 'ğŸ“š', 'ğŸ“–', 'âœï¸', 'ğŸ“', 'ğŸ†', 'ğŸ¯', 'ğŸ²', 'ğŸ°'];

    function createLinkForm(index) {
      const isFirst = index === 0;
      const isLast = index === 5;

      return `
        <div class="form-section">
          <h3><span class="link-number">${index + 1}</span> Link ${index + 1}</h3>

          ${isFirst ? `
            <div class="form-group">
              <label>Category (clue for first link only)</label>
              <input type="text" id="link${index}_category" placeholder="e.g., Ocean animal">
              <div class="hint">This is shown to the player for the first link</div>
            </div>
          ` : ''}

          <div class="form-group">
            <label>Decoded Word (answer)</label>
            <input type="text" id="link${index}_decoded" placeholder="e.g., SHARK" style="text-transform: uppercase;">
          </div>

          <div class="form-group">
            <label>Visual</label>
            <div class="image-source-toggle" id="imageToggle${index}">
              <button type="button" class="active" onclick="setImageSource(${index}, 'emoji')">Emoji</button>
              <button type="button" onclick="setImageSource(${index}, 'unsplash')">Unsplash</button>
            </div>
            <div id="emojiSection${index}">
              <input type="text" id="link${index}_emoji" placeholder="ğŸ¦ˆ" maxlength="2">
              <div class="emoji-picker" id="emojiPicker${index}"></div>
            </div>
            <div id="unsplashSection${index}" style="display:none">
              <div class="unsplash-search-row">
                <input type="text" id="link${index}_unsplash_query" placeholder="Search Unsplash photos..."
                  onkeydown="if(event.key==='Enter'){event.preventDefault();searchUnsplashForLink(${index})}">
                <button type="button" onclick="searchUnsplashForLink(${index})">Search</button>
              </div>
              <div id="unsplashResults${index}"></div>
              <div id="unsplashSelected${index}"></div>
            </div>
            <input type="hidden" id="link${index}_imageUrl" value="">
            <input type="hidden" id="link${index}_imageCreditName" value="">
            <input type="hidden" id="link${index}_imageCreditUsername" value="">
            <input type="hidden" id="link${index}_imageCreditProfileUrl" value="">
          </div>

          <div class="form-group">
            <label>Disguised Word Options (4 required)</label>
            <div class="option-grid">
              <input type="text" id="link${index}_opt0" placeholder="shrk (correct)">
              <input type="text" id="link${index}_opt1" placeholder="cml">
              <input type="text" id="link${index}_opt2" placeholder="frg">
              <input type="text" id="link${index}_opt3" placeholder="lbrtr">
            </div>
            <div class="hint">First option should be the correct answer</div>
          </div>

          <div class="form-group">
            <label>Correct Answer (disguised)</label>
            <input type="text" id="link${index}_answer" placeholder="shrk">
            <div class="hint">Should match the first option above</div>
          </div>

          ${!isLast ? `
            <div class="form-group">
              <label>Bridge Hint (connection to next word)</label>
              <input type="text" id="link${index}_bridge" placeholder="Has sharp teeth...">
              <div class="hint">Helps show the connection logic</div>
            </div>
          ` : ''}
        </div>
      `;
    }

    function initializeForm() {
      const container = document.getElementById('linksContainer');
      let html = '';
      for (let i = 0; i < 6; i++) {
        html += createLinkForm(i);
      }
      container.innerHTML = html;

      // Add emoji pickers
      for (let i = 0; i < 6; i++) {
        const picker = document.getElementById(`emojiPicker${i}`);
        commonEmojis.forEach(emoji => {
          const span = document.createElement('span');
          span.className = 'emoji-option';
          span.textContent = emoji;
          span.onclick = () => {
            document.getElementById(`link${i}_emoji`).value = emoji;
          };
          picker.appendChild(span);
        });
      }

      // Load sample data
      loadSampleData();
    }

    function loadSampleData() {
      const sample = {
        number: 47,
        date: "Wednesday",
        links: [
          { category: "Ocean animal", decoded: "SHARK", emoji: "ğŸ¦ˆ", options: ["shrk", "cml", "frg", "lbrtr"], answer: "shrk", bridge: "Has sharp teeth..." },
          { decoded: "DRILL", emoji: "ğŸ› ï¸", options: ["drl", "hmrtn", "skrw", "pncl"], answer: "drl", bridge: "Makes holes..." },
          { decoded: "DERRICK", emoji: "ğŸ—¼", options: ["drik", "pump", "fns", "bskt"], answer: "drik", bridge: "Tall tower..." },
          { decoded: "EIFFEL", emoji: "ğŸ—¼", options: ["efl", "lvr", "notr", "mprs"], answer: "efl", bridge: "Made of iron..." },
          { decoded: "IRON", emoji: "â›³", options: ["irn", "wdg", "putr", "drvr"], answer: "irn", bridge: "Pressed flat..." },
          { decoded: "COLLAR", emoji: "ğŸ‘”", options: ["colr", "slf", "cuf", "bttn"], answer: "colr" }
        ]
      };

      document.getElementById('puzzleNumber').value = sample.number;
      document.getElementById('puzzleDate').value = sample.date;

      sample.links.forEach((link, i) => {
        if (link.category) document.getElementById(`link${i}_category`).value = link.category;
        document.getElementById(`link${i}_decoded`).value = link.decoded;
        document.getElementById(`link${i}_emoji`).value = link.emoji;
        link.options.forEach((opt, j) => {
          document.getElementById(`link${i}_opt${j}`).value = opt;
        });
        document.getElementById(`link${i}_answer`).value = link.answer;
        if (link.bridge) document.getElementById(`link${i}_bridge`).value = link.bridge;
      });
    }

    // Unsplash search and selection for puzzle generator
    let unsplashResultsData = {};  // linkIndex -> results array

    function setImageSource(index, source) {
      const toggle = document.getElementById(`imageToggle${index}`);
      toggle.querySelectorAll('button').forEach(btn => {
        btn.classList.toggle('active', btn.textContent.toLowerCase() === source);
      });
      document.getElementById(`emojiSection${index}`).style.display = source === 'emoji' ? 'block' : 'none';
      document.getElementById(`unsplashSection${index}`).style.display = source === 'unsplash' ? 'block' : 'none';

      // Clear the other source when switching
      if (source === 'emoji') {
        document.getElementById(`link${index}_imageUrl`).value = '';
        document.getElementById(`link${index}_imageCreditName`).value = '';
        document.getElementById(`link${index}_imageCreditUsername`).value = '';
        document.getElementById(`link${index}_imageCreditProfileUrl`).value = '';
        document.getElementById(`unsplashSelected${index}`).innerHTML = '';
      } else if (source === 'unsplash') {
        document.getElementById(`link${index}_emoji`).value = '';
      }
    }

    async function searchUnsplashForLink(index) {
      const query = document.getElementById(`link${index}_unsplash_query`).value.trim();
      if (!query) return;

      const container = document.getElementById(`unsplashResults${index}`);
      container.innerHTML = '<div class="unsplash-status">Searching...</div>';

      try {
        const resp = await fetch(`/api/unsplash/search?query=${encodeURIComponent(query)}&per_page=8`);
        const data = await resp.json();
        if (data.error) {
          container.innerHTML = `<div class="unsplash-status">${data.error}</div>`;
          return;
        }

        unsplashResultsData[index] = data.results || [];
        if (data.results.length === 0) {
          container.innerHTML = '<div class="unsplash-status">No photos found</div>';
          return;
        }

        container.innerHTML = `<div class="unsplash-results">${data.results.map(photo => `
          <div class="thumb" onclick="selectUnsplashPhoto(${index}, '${photo.id}')">
            <img src="${photo.thumb}" alt="${(photo.alt || '').replace(/"/g, '&quot;')}" loading="lazy">
            <div class="photo-credit">${photo.credit.name}</div>
          </div>
        `).join('')}</div>`;
      } catch (e) {
        container.innerHTML = `<div class="unsplash-status">Error: ${e.message}</div>`;
      }
    }

    function selectUnsplashPhoto(index, photoId) {
      const results = unsplashResultsData[index] || [];
      const photo = results.find(p => p.id === photoId);
      if (!photo) return;

      document.getElementById(`link${index}_imageUrl`).value = photo.small;
      document.getElementById(`link${index}_imageCreditName`).value = photo.credit.name;
      document.getElementById(`link${index}_imageCreditUsername`).value = photo.credit.username;
      document.getElementById(`link${index}_imageCreditProfileUrl`).value = photo.credit.profileUrl;
      document.getElementById(`link${index}_emoji`).value = '';

      // Show selected preview
      document.getElementById(`unsplashSelected${index}`).innerHTML = `
        <div class="selected-image-preview">
          <img src="${photo.thumb}" alt="">
          <div class="info">
            Selected photo
            <div class="credit">by ${photo.credit.name}</div>
          </div>
          <button type="button" onclick="clearUnsplashSelection(${index})">Clear</button>
        </div>
      `;

      // Trigger download event
      fetch('/api/unsplash/download', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ photo_id: photoId }),
      }).catch(() => {});
    }

    function clearUnsplashSelection(index) {
      document.getElementById(`link${index}_imageUrl`).value = '';
      document.getElementById(`link${index}_imageCreditName`).value = '';
      document.getElementById(`link${index}_imageCreditUsername`).value = '';
      document.getElementById(`link${index}_imageCreditProfileUrl`).value = '';
      document.getElementById(`unsplashSelected${index}`).innerHTML = '';
    }

    function generateCode() {
      const puzzleNumber = document.getElementById('puzzleNumber').value;
      const puzzleDate = document.getElementById('puzzleDate').value;

      const links = [];
      for (let i = 0; i < 6; i++) {
        const link = {
          decoded: document.getElementById(`link${i}_decoded`).value.toUpperCase(),
          emoji: document.getElementById(`link${i}_emoji`).value,
          options: [
            document.getElementById(`link${i}_opt0`).value,
            document.getElementById(`link${i}_opt1`).value,
            document.getElementById(`link${i}_opt2`).value,
            document.getElementById(`link${i}_opt3`).value
          ],
          answer: document.getElementById(`link${i}_answer`).value
        };

        // Include image data if present
        const imageUrl = document.getElementById(`link${i}_imageUrl`).value;
        if (imageUrl) {
          link.imageUrl = imageUrl;
          link.imageCredit = {
            name: document.getElementById(`link${i}_imageCreditName`).value,
            username: document.getElementById(`link${i}_imageCreditUsername`).value,
            profileUrl: document.getElementById(`link${i}_imageCreditProfileUrl`).value,
          };
        }

        if (i === 0) {
          link.category = document.getElementById(`link${i}_category`).value;
        }

        if (i < 5) {
          link.bridge = document.getElementById(`link${i}_bridge`).value;
        }

        links.push(link);
      }

      const code = `const CHAIN_DATA = {
  number: ${puzzleNumber},
  date: "${puzzleDate}",
  links: [
${links.map((link, i) => `    {
${i === 0 ? `      category: "${link.category}",\n` : ''}      options: [${link.options.map(o => `"${o}"`).join(', ')}],
      answer: "${link.answer}",
      decoded: "${link.decoded}",
      emoji: "${link.emoji}",${link.imageUrl ? `
      imageUrl: "${link.imageUrl}",
      imageCredit: { name: "${link.imageCredit.name}", profileUrl: "${link.imageCredit.profileUrl}" },` : ''}
      bridge: ${i < 5 ? `"${link.bridge}"` : 'null'}
    }`).join(',\n')}
  ]
};`;

      document.getElementById('output').textContent = code;
    }

    function copyToClipboard() {
      const output = document.getElementById('output').textContent;
      navigator.clipboard.writeText(output).then(() => {
        showCopySuccess();
      });
    }

    function showCopySuccess() {
      const notification = document.createElement('div');
      notification.className = 'copy-success';
      notification.textContent = 'âœ“ Copied to clipboard!';
      document.body.appendChild(notification);
      setTimeout(() => notification.remove(), 2000);
    }

    function resetForm() {
      if (confirm('Reset form to default sample data?')) {
        loadSampleData();
        generateCode();
      }
    }

    // Initialize on load
    initializeForm();
  </script>
</body>
</html>
